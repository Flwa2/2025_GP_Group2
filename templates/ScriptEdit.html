<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WeCast • Edit Script</title>
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='logo.png') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="bg-app">

  <header class="app-header">
    <a href="{{ url_for('home') }}" class="logo-link">
      <img src="{{ url_for('static', filename='logo.png') }}" alt="WeCast Logo" class="app-logo">
      <span class="logo-text">WeCast</span>
    </a>
  </header>

  <div class="main-container">
    <h1 class="title">Edit Your Podcast Script</h1>

    <!-- Progress Wizard: 1 and 2 are done, 3 is active -->
    <div class="wizard">
      <div class="wizard-step">
        <div id="wiz-1" class="wizard-dot wiz-done">1</div>
        <div class="wizard-label">Settings</div>
      </div>

      <div id="line-12" class="wizard-line wizard-line--on"></div>

      <div class="wizard-step">
        <div id="wiz-2" class="wizard-dot wiz-done">2</div>
        <div class="wizard-label">Text</div>
      </div>

      <div id="line-23" class="wizard-line wizard-line--on"></div>

      <div class="wizard-step">
        <div id="wiz-3" class="wizard-dot wiz-active">3</div>
        <div class="wizard-label">Edit</div>
      </div>
    </div>

<div class="guidelines-box">
  <h2>Editing Guidelines</h2>
  <ul class="guidelines-list">
    <li><span class="num">1</span> Keep speaker names (e.g., <code>Host:</code>, <code>Guest:</code>). Don’t delete or rename them.</li>
    <li><span class="num">2</span> Edit only the words after the colon on each line. Keep one speaker per line.</li>
    <li><span class="num">3</span> Don’t clear the whole script or remove an entire speaker’s part.</li>
  </ul>
</div>

      {% if error %}
        <div class="error-msg">{{ error }}</div>
      {% endif %}
      {% if success %}
        <div class="save-status">{{ success }}</div>
      {% endif %}

      <form method="POST" action="{{ url_for('edit') }}">
        <div class="script-container">
          <label for="scriptEditor">Your Script</label>
          <textarea id="scriptEditor" name="edited_script" style="width:100%; min-height:48vh; line-height:1.55; resize:vertical; box-sizing:border-box;">{{ script or '' }}</textarea>
        </div>

<div class="save-section">
  <div class="btn-row">
    <a href="{{ url_for('create_page') }}?step=2&restore=1"
       class="secondary-btn btn-equal">Back to Text</a>
    <button id="saveBtn" type="button"
            class="btn-primary btn-equal">Save Script</button>
            <button id="audioBtn" type="button" class="btn-primary btn-equal">
Generate Audio
</button>
<audio id="audioPlayer" controls style="display:none; margin-top:1rem; width:100%;"></audio>

  </div>
  <span id="saveStatus" class="save-status">Not saved yet</span>
</div>

      </form>
    </div>
  </div>
<script>
  const saveBtn = document.getElementById('saveBtn');
  const saveStatus = document.getElementById('saveStatus');
  const editor = document.getElementById('scriptEditor');

  saveBtn.addEventListener('click', async () => {
    const content = editor.value.trim();
    if (!content) {
      saveStatus.textContent = 'Script is empty.';
      saveStatus.style.color = '#ff6b6b';
      return;
    }

    saveStatus.textContent = 'Saving...';
    saveStatus.style.color = '#a0ffb4';

    try {
      const response = await fetch('{{ url_for("edit") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ edited_script: content })
      });

      if (response.ok) {
        saveStatus.textContent = 'Last saved: ' + new Date().toLocaleTimeString();
        saveStatus.style.color = '#10b981';
      } else {
        saveStatus.textContent = 'Failed to save.';
        saveStatus.style.color = '#ff6b6b';
      }
    } catch (err) {
      saveStatus.textContent = 'Error saving script.';
      saveStatus.style.color = '#ff6b6b';
    }
  });

   const audioBtn = document.getElementById('audioBtn');
  const audioPlayer = document.getElementById('audioPlayer');

  audioBtn.addEventListener('click', async () => {
    const content = editor.value.trim();
    if (!content) return alert('Script is empty.');

    audioBtn.textContent = 'Generating...';
    audioBtn.disabled = true;

    try {
      const response = await fetch('/generate_audio', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ scriptText: content })
      });

      const data = await response.json();
      if (data.url) {
        audioPlayer.src = data.url + '?t=' + new Date().getTime(); // prevent cache
        audioPlayer.style.display = 'block';
        audioPlayer.play();
        audioBtn.textContent = ' Regenerate Audio';
      } else {
        alert('Error: ' + (data.error || 'Unknown error'));
        audioBtn.textContent = ' Generate Audio';
      }
    } catch (err) {
      alert('Error generating audio.');
      audioBtn.textContent = ' Generate Audio';
    } finally {
      audioBtn.disabled = false;
    }
  });
</script>


</body>
</html>
